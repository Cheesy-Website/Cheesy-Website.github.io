class BungeeProSource extends AudioWorkletNode{static async source(t,N,i=0){var s=N.arrayBuffer;if(!(s=(s??=N.audioBuffer)??N.url))throw new Error("asset must have either an 'url', an 'arrayBuffer' or an 'audioBuffer' property.");let g=i,y=(g=Math.max(g,131072),Math.ceil(g/8));class v{#t;#i;#H=null;constructor(t,i){t instanceof ArrayBuffer?this.#H=t:(this.#t=t,this.#i=i?JSON.parse(JSON.stringify(i)):{},(this.#i??={}).headers??={})}async o(t,i){if(!this.#H){this.#i.headers.Range=`bytes=${t}-`+(void 0===i?"":i-1);var s=await fetch(this.#t,this.#i);if(200==s.status&&((t||i)&&this.#i.headers.Range,this.#H=await s.arrayBuffer()),206==s.status)return s.arrayBuffer()}if(this.#H)return this.#H.slice(t,void 0===i?this.#H.byteLength:i)}}class e{C={};yt(){this.C.vt=1+Math.max(0,Math.ceil((this.C.it.g-this.C.it.m)/this.C.it.p))}}class h extends e{#u;#l=[];#m=[];#p=[];#g=[];#N;#v;#K;#A;#$;C={};async S(i,t,s){this.#u=new v(t,s);var e=new Uint8Array(await this.#u.o(0));let h=0,r=0,a=0,n=!1;var o=N.stemCount||1,u=N.stemIndex||0;for("ID3"===String.fromCharCode(e[0],e[1],e[2])&&(t=(127&e[6])<<21|(127&e[7])<<14|(127&e[8])<<7|127&e[9],r=10+t);r<e.length-40;){var f=e[r+0],_=e[r+1],m=e[r+2],l=e[r+3];if(255!=f||_<224)break;this.h=4-(_>>1&3);if(4==this.h){if(0==(16&_))break;0==h&&(this.#$=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350,0,0,0][m>>2&15],f=[0,1,2,3,4,5,6,8,0][7&(m<<2|l>>6)],this.#N=1024,this.C.u=i.sampleRate,this.C.l=f);var f=e[r+4],c=e[r+5];a=8191&(l<<11|f<<3|c>>5)}else{f=[2.5,0,2,1][_>>3&3];let t=4;1==f?t=this.h-1:1==this.h&&(t=3);var c=1e3*[[0,0,0,0,0],[32,32,32,32,8],[64,48,40,48,16],[96,56,48,56,24],[128,64,56,64,32],[160,80,64,80,40],[192,96,80,96,48],[224,112,96,112,56],[256,128,112,128,64],[288,160,128,144,80],[320,192,160,160,96],[352,224,192,176,112],[384,256,224,192,128],[416,320,256,224,144],[448,384,320,256,160],[0,0,0,0,0]][m>>4&15][t],_=m>>2&3,p=Math.ceil(f)-1;if(this.#$=[[44100,22050,11025],[48e3,24e3,12e3],[32e3,16e3,8e3],[0,0,0]][_][p],!f||!c||!this.#$)break;0==h&&(this.#N=1==this.h?384:1152,this.C.u=i.sampleRate,this.C.l=3==(l>>6&3)?1:2);_=m>>1&1;if(a=1==this.h?4*Math.floor(12*c/this.#$+_):Math.floor(144*c/this.#$+_),!n&&0==h&&36<=a){for(var d of[13,21,36]){var w=String.fromCharCode(e[r+d+0],e[r+d+1],e[r+d+2],e[r+d+3]);if(("Xing"==w||"Info"==w)&&a>=d+120+36){r,d,n=!0;break}}if(n){r+=a;continue}}}if(0==h&&(this.C.it={},this.#K=Math.floor((g-128)*this.#$/(this.#N*i.sampleRate)),p=this.#N*i.sampleRate/this.#$,this.C.it.m=Math.ceil(this.#K*p),f=Math.ceil(y*this.#$/i.sampleRate),this.#A=Math.floor((this.C.it.m-f)/p),this.C.it.p=this.#A*p,this.#$,i.sampleRate,this.#K,this.#N,y),e.length-r<a)break;l=Math.floor(this.#A*(1-u/o))%this.#A,m=(h%this.#A!=l&&0!=h||(this.#l.push(r),this.#p.push(h*this.#N),this.#m.push(-1),this.#g.push(-1)),this.#K-this.#A);1<this.#m.length&&(h-m)%this.#A==l&&(this.#m[this.#m.length-2]=r,this.#g[this.#g.length-2]=h*this.#N),r+=a,++h}return 0!=this.#l.length&&(1<this.#m.length&&this.#m[this.#m.length-2]<0&&(this.#l.pop(),this.#m.pop(),this.#p.pop(),this.#g.pop()),this.#m[this.#m.length-1]=r,this.#g[this.#g.length-1]=h*this.#N,this.C.it.g=h*this.#N*i.sampleRate/this.#$,this.yt(),this.#v=new OfflineAudioContext(this.C.l,this.C.it.m,i.sampleRate),this.duration=this.C.it.g/this.C.u,!0)}async j(t){if(t<0||t>=this.#m.length)return Promise.resolve({st:t});var i=await this.#u.o(this.#l[t],this.#m[t]),s=(i.byteLength,this.#m[t],this.#l[t],await this.#v.decodeAudioData(i)),e=(s.numberOfChannels,this.C.l,s.length,g,[]);for(let t=0;t<this.C.l;++t)e[t]=s.getChannelData(t);return{et:this.#p[t]*this.#v.sampleRate/this.#$,rt:e,ot:0==t,_t:t==this.#p.length-1}}}class r extends e{#cft;St(){this.C={l:this.#cft.numberOfChannels,u:this.#cft.sampleRate,vt:1+Math.ceil((this.#cft.length-g)/(g-y)),it:{g:this.#cft.length,m:g,p:g-y}},this.duration=this.C.it.g/this.C.u}async S(t,i,s){return i instanceof ArrayBuffer||(i=await(await fetch(i,s)).arrayBuffer()),this.Bt(await new OfflineAudioContext(t.destination.channelCount,10*t.sampleRate,t.sampleRate).decodeAudioData(i)),!0}async Bt(t){return this.#cft=t,this.St(),!0}async j(t){if(t<0||t*this.C.it.p>=this.C.it.g)return Promise.resolve({st:t});var i=t*this.C.it.p,s=Math.min(this.C.it.g,i+this.C.it.m),e=[];for(let t=0;t<this.C.l;++t)e[t]=new Float32Array(s-i),this.#cft.copyFromChannel(e[t],t,i);return Promise.resolve({st:t,et:i,rt:e,ot:0==i,_t:s==this.#cft.length})}}if(s instanceof AudioBuffer){let t=new r;return await t.Bt(s),t}i=new h;if(await i.S(t,s,N.options))return i;let a=new r;return await a.S(t,s,N.options),a}static#G=new WeakMap;static async processor(t,i){if(!(t.audioWorklet&&t.audioWorklet instanceof AudioWorklet))throw Error("AudioWorklet seems unsupported by this AudioContext");BungeeProSource.#G.has(t)||BungeeProSource.#G.set(t,{});var s="bungee-pro",e=new URL(s+".js",import.meta.url).toString(),h=new URL(s+".wasm",import.meta.url).toString(),r=BungeeProSource.#G.get(t);return r[s]??=t.audioWorklet.addModule(e,i),await r[s],{ft:t,_:await fetch(h,i).then(t=>t.arrayBuffer()),Y:s}}constructor(t,i){let s=(t=Array.isArray(t)?t:[t]).map(t=>t.C);if(s.some(t=>t.l!==s[0].l))throw"stem channel counts inconsistent";if(s.some(t=>t.u!==s[0].u))throw"stem sample rates inconsistent";if(s.some(t=>t.it.g!==s[0].it.g))throw"stem lengths inconsistent";if(s.some(t=>t.it.m!==s[0].it.m)||s.some(t=>t.it.p!==s[0].it.p))throw"stem compression inconsistent";super(i.ft,i.Y.endsWith("pro")?"BungeeWebPro":"BungeeWebBasic",{outputChannelCount:[s[0].l],processorOptions:{_:i._,C:s[0],bt:t.length}}),delete i._,this.#At=t,this.hz.Mt=Array(s[0].l*t.length).fill(1);for(let t=0;t<this.#At.length;++t)this.#st.push([-1,-1]);super.port.onmessage=t=>this.#it(t)}start(t=0){isNaN(this.hz.Nt)&&!isNaN(t)&&(this.hz.Nt=Number(t))}stop(t=0){isNaN(this.hz.gt)&&!isNaN(t)&&(this.hz.gt=Number(t))}get gain(){let s=this.inputChannelCount,h=(t,i)=>{if(!(0<=t&&t<this.#At.length))throw new Error("invalid stem index");if(0<=i&&i<s)return t*s+i;throw new Error("invalid channel index")};return new Proxy(this.hz,{get:(t,e)=>(e=Number(e),new Proxy(t,{get:(t,i)=>(i=Number(i),check(e,i),"Mt"in t?t.Mt[h(e,i)]:t._getGain(h(e,i))),set:(t,i,s)=>(i=Number(i),"Mt"in t?t.Mt[h(e,i)]=s:t._setGain(h(e,i),s),!0)}))})}#At;#st=[];#B=!1;#tt(i,s,e){s<0||s===this.#st[i][0]||s===this.#st[i][1]||this.#B||(this.#B=!0,this.#st[i][e]=s,this.#At[i].j(s).then(t=>{"rt"in t&&(t.xt=i,t.Ct=s,t.Pt=e,super.port.postMessage(t,t.rt?t.rt.map(t=>t.buffer):[])),this.#B=!1}))}get inputDuration(){return this.#At[0].C.it.g/this.#At[0].C.u}get inputSampleRate(){return this.#At[0].C.u}get inputChannelCount(){return this.#At[0].C.l}seek(t){this.hz.ht=Number(t)*this.#At[0].C.u}set speed(t){this.hz.at=Number(t)}get speed(){return this.hz.at}set pitch(t){t=Number(t),isNaN(t)?this.hz.nt=1:this.hz.nt=Math.max(.25,Math.min(4,t))}get pitch(){return this.hz.nt}#_St(){this.#_vt?(this.hz.ut=this.#ot*this.#At[0].C.u,this.hz.lt=this.#_t*this.#At[0].C.u):(this.hz.ut=0,this.hz.lt=-1)}set loop(t){this.#_vt=Boolean(t),this.#_St()}get loop(){return this.#_vt}#_vt=!1;set loopStart(t){this.#ot=Number(t),this.#_St()}get loopStart(){return this.#ot}#ot=0;set loopEnd(t){this.#_t=Number(t),this.#_St()}get loopEnd(){return this.#_t}#_t=0;get position(){var t,i;return this.fta?isNaN(this.fta.M)?(this.#dt=0,this.#ct=NaN):(i=(t=performance.now())-this.#gt,this.#gt=t,t=Math.pow(.5,50*i),this.#dt*=t,t=this.#ct+this.fta.M*this.#At[0].C.u*i*.001-(this.fta.P+this.#dt),isNaN(t)||(this.#dt+=t,i=.05*this.#At[0].C.u,this.#dt>i&&(this.#dt=i),this.#dt<-i&&(this.#dt=-i)),this.#ct=this.fta.P+this.#dt,Number((this.fta.P+this.#dt)/this.#At[0].C.u)):NaN}#gt=0;#dt=0;#ct=NaN;#yct;fta;hz={ht:0,at:NaN,nt:1,ut:NaN,lt:NaN,Nt:NaN,gt:NaN};t(){}i(){}#it(t){t.data.v,new Function(t.data.v).call(this),this.wt=t.data,delete this.wt.v,super.port.onmessage=t=>this.#St(t)}#vat=0;#Bt=0;#Art=0;#Ct=[[0,1],[0,0]];get workletThreadUsage(){var t=performance.now(),i=t-this.#Art,t=(this.#Art=t,[.002,5e-4]),i=[Math.pow(.5,i*t[0]),Math.pow(.5,i*t[1])],t=(this.#Ct[0][0]*=i[0],this.#Ct[0][1]*=i[0],this.#Ct[1][0]*=i[1],this.#Ct[1][1]*=i[1],this.#Ct[0][0]-=this.#vat,this.#Ct[0][1]-=this.#Bt,this.#Ct[1][0]+=this.#vat,this.#Ct[1][1]+=this.#Bt,this.#vat=this.#Bt=0,[this.#Ct[0][0]+this.#Ct[1][0],this.#Ct[0][1]+this.#Ct[1][1]]);return t[0]/(t[0]+t[1]+1e-9)}#St(t){if(t.data instanceof Uint8Array){if(!this.fta){var i=this.hz;this.hz=new this.t(new ArrayBuffer(t.data.length)),this.hz.ht=i.ht,this.hz.at=i.at,this.hz.nt=i.nt,this.hz.ut=i.ut,this.hz.lt=i.lt,this.hz.Nt=i.Nt,this.hz.gt=i.gt;for(let t=0;t<i.Mt.length;++t)this.hz._setGain(t,i.Mt[t]);this.fta=new this.i(new ArrayBuffer(this.i.length)),this.#yct=new Uint8Array(t.data.byteLength)}var s=this.#yct;this.#yct=t.data;for(let t=0;t<this.fta.byteLength;++t)this.fta.setUint8(t,this.#yct[t]);this.#vat+=this.fta.N,this.#Bt+=this.fta.B;for(let t=0;t<this.hz.byteLength;t++)s[t]=this.hz.getUint8(t);isNaN(this.hz.at)||(this.hz.ht=NaN);for(let t=0;t<this.#At.length;++t)this.#tt(t,this.fta._stemSegmentIndexNeeded(t),this.fta._stemSegmentWhither(t));super.port.postMessage(s,[s.buffer])}else if(t.data instanceof Error)throw t.data}}export{BungeeProSource};