<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CHATTING_PROGRAM.EXE</title>
<style>
  @font-face {
    font-family: "utfont";
    src: url("https://cheesy-website.netlify.app/fonts/determinationsanswebregular-369x-webfont.woff") format("woff"),
         url("https://cheesy-website.netlify.app/fonts/determinationsanswebregular-369x.ttf") format("truetype");
  }

  body {
    margin: 0;
    padding: 0;
    background-color: black;
    color: white;
    font-family: "utfont";
    font-size: 28px;
    height: 100vh;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #start-button, #skip-button {
    font-family: "utfont";
    font-size: 32px;
    color: white;
    background: none;
    border: 2px solid white;
    padding: 10px 20px;
    cursor: pointer;
    position: absolute;
    z-index: 10;
  }

  #skip-button {
    top: 20px;
    right: 20px;
    display: none;
  }

  #start-button:hover, #skip-button:hover {
    color: yellow;
    border-color: yellow;
  }

  #startup-video, #bg-video {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
    display: none;
  }

  #nickname-screen, #chat-screen {
    width: 640px;
    max-width: 95%;
    display: none;
    flex-direction: column;
    align-items: center;
    opacity: 0;
    transition: opacity 1.5s ease;
  }

  #nickname-screen.show, #chat-screen.show {
    display: flex;
    opacity: 1;
  }

  #chat-box {
    border: 3px solid white;
    width: 100%;
    height: 400px;
    background-color: rgba(0,0,20,0.9);
    padding: 10px;
    overflow-y: auto;
    margin-bottom: 10px;
    white-space: pre-wrap;
  }

  .msg {
    margin: 6px 0;
  }

  .separator {
    text-align: center;
    opacity: 0.5;
    margin: 8px 0;
  }

  input, button {
    font-family: "utfont";
    font-size: 24px;
    color: white;
    background: black;
    border: 2px solid white;
    padding: 6px 10px;
    margin: 2px;
  }

  button:hover {
    color: yellow;
    border-color: yellow;
    cursor: pointer;
  }

  #chat-form {
    display: flex;
    width: 100%;
  }

  #chat-input {
    flex: 1;
  }

  /* Hidden trust button */
  #grant-cookie-btn {
    position: fixed;
    top: 6px;
    left: 6px;
    z-index: 9999;
    width: 26px;
    height: 26px;
    opacity: 0;
    border: none;
    background: transparent;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- Hidden trust-grant button -->
<button id="grant-cookie-btn" title="Grant trusted cookie" aria-label="Grant trusted cookie"></button>

<!-- Start and Skip Buttons -->
<button id="start-button">▶ START CHAT</button>
<button id="skip-button">SKIP INTRO</button>

<!-- Startup and Background Videos -->
<video id="startup-video">
  <source src="startup.mp4" type="video/mp4">
</video>

<video id="bg-video" loop>
  <source src="background.mp4" type="video/mp4">
</video>

<!-- Chat Interface -->
<div id="nickname-screen">
  <div>ENTER NICKNAME:</div>
  <input type="text" id="nickname-input" placeholder="YOUR NAME">
  <div>ROOM CODE (leave empty for public):</div>
  <input type="text" id="room-input" placeholder="ROOM CODE">
  <button id="join-btn">JOIN CHAT</button>
</div>

<div id="chat-screen">
  <div id="chat-box"></div>
  <form id="chat-form">
    <input id="chat-input" placeholder="TYPE MESSAGE..." autocomplete="off">
    <button type="submit">SEND</button>
  </form>
  <button id="change-nickname-btn">CHANGE NICKNAME</button>
</div>

<audio id="type-sound" src="type.wav"></audio>
<audio id="click-sound" src="click.wav"></audio>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://jynzopjzhmpmkeooqyrt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnpvcGp6aG1wbWtlb29xeXJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTYzODEsImV4cCI6MjA3NzEzMjM4MX0.o7rmQM3uEpaU8vXihOjIZDt8Vg8A2TX23sd1K51I80s";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let nickname = "";
let room = "public";
let lastSender = null;

const nicknameScreen = document.getElementById("nickname-screen");
const chatScreen = document.getElementById("chat-screen");
const chatBox = document.getElementById("chat-box");
const nicknameInput = document.getElementById("nickname-input");
const roomInput = document.getElementById("room-input");
const joinBtn = document.getElementById("join-btn");
const chatInput = document.getElementById("chat-input");
const chatForm = document.getElementById("chat-form");
const changeNickBtn = document.getElementById("change-nickname-btn");

const typeSound = document.getElementById("type-sound");
const clickSound = document.getElementById("click-sound");

function playClick() { clickSound.currentTime = 0; clickSound.play(); }
function playType() { typeSound.currentTime = 0; typeSound.play(); }

// Bad-word filter
const blacklist = [
  "fucker","fucking","fuck","shit","bitch","asshole","bastard","slut","whore",
  "nigger","faggot","cunt","dick","pussy","retard",
  "kike","chink","spic","tranny","cock","nigga"
];

joinBtn.onclick = () => {
  playClick();
  nickname = nicknameInput.value.trim() || "Anon" + Math.floor(Math.random()*1000);
  room = roomInput.value.trim() || "public";
  nicknameScreen.classList.remove("show");
  nicknameScreen.style.display = "none";
  chatScreen.classList.add("show");
  subscribeToRoom(room);
};

changeNickBtn.onclick = () => {
  const newNick = prompt("Enter new nickname:", nickname);
  if (newNick) nickname = newNick;
};

function censorText(text) {
  let result = text;
  blacklist.forEach(word => {
    const regex = new RegExp("\\b" + word + "\\b", "gi");
    result = result.replace(regex, "****");
  });
  return result;
}

chatForm.onsubmit = async (e) => {
  e.preventDefault();
  let text = chatInput.value.trim();
  if (!text) return;
  text = censorText(text);
  await sb.from("messages").insert([{ sender: nickname, content: text, room: room }]);
  chatInput.value = "";
  playClick();
};

function parseBBColor(text) {
  return text.replace(/\[color=(#[0-9A-Fa-f]{6})\](.*?)\[\/color\]/g, '<span style="color:$1">$2</span>');
}

// Cookie utils
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = name + "=" + encodeURIComponent(value) + ";path=/;expires=" + d.toUTCString() + ";SameSite=Lax";
}
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? decodeURIComponent(match[2]) : null;
}

// Trust system
const TRUSTED_COOKIE_NAME = "chat_trusted";
const TRUSTED_COOKIE_VALUE = "t0k3n_12251997_9f3b7c";
const GRANT_PASSPHRASE = "12251997";
const trustedUsers = ["CheesyKid", "FriendKid"];

const grantBtn = document.getElementById("grant-cookie-btn");
grantBtn.addEventListener("click", () => {
  const attempt = prompt("Enter trust passphrase:");
  if (!attempt) return;
  if (attempt === GRANT_PASSPHRASE) {
    setCookie(TRUSTED_COOKIE_NAME, TRUSTED_COOKIE_VALUE, 36500); // ~100 years
    alert("Trusted cookie granted!");
  } else {
    alert("Wrong passphrase.");
  }
});

async function typeWriter(element, text, totalDuration = 2500, allowHTML = false) {
  element.innerHTML = "";
  if (!allowHTML) {
    const len = text.length;
    const speed = Math.max(totalDuration / len, 10);
    for (let i = 0; i < len; i++) {
      element.textContent = text.slice(0, i + 1);
      chatBox.scrollTop = chatBox.scrollHeight;
      playType();
      await new Promise(res => setTimeout(res, speed));
    }
  } else {
    element.innerHTML = text;
    playType();
  }
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function renderMessage(msg, useTypewriter = true) {
  const cookieTrusted = (getCookie(TRUSTED_COOKIE_NAME) === TRUSTED_COOKIE_VALUE);
  if (lastSender !== null && lastSender !== msg.sender) {
    const line = document.createElement("div");
    line.className = "separator";
    line.textContent = "────────────────────────────";
    chatBox.appendChild(line);
  }
  const div = document.createElement("div");
  div.className = "msg";
  chatBox.appendChild(div);
  const escapeHTML = (str) =>
    str.replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[c]));
  const isTrusted = trustedUsers.includes(msg.sender) || cookieTrusted;
  const sender = escapeHTML(msg.sender);
  const content = escapeHTML(msg.content);
  const finalSender = isTrusted ? parseBBColor(sender) : sender;
  const finalContent = isTrusted ? parseBBColor(content) : content;
  if (useTypewriter)
    await typeWriter(div, `${finalSender}: ${finalContent}`, 2500, isTrusted);
  else {
    div.innerHTML = isTrusted ? `${finalSender}: ${finalContent}` : `${finalSender}: ${finalContent}`;
    chatBox.scrollTop = chatBox.scrollHeight;
  }
  lastSender = msg.sender;
}

async function subscribeToRoom(roomName) {
  const { data: messages } = await sb.from("messages").select("*").eq("room", roomName).order("id", { ascending: true });
  chatBox.innerHTML = "";
  lastSender = null;
  for (const msg of messages) await renderMessage(msg, false);
  sb.channel("room-" + roomName)
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages", filter: `room=eq.${roomName}` },
      payload => renderMessage(payload.new, true))
    .subscribe();
}
</script>
</body>
</html>
