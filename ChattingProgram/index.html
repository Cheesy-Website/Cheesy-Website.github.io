<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CHATTING_PROGRAM.EXE</title>
<style>
  @font-face {
    font-family: "utfont";
    src: url("https://cheesy-website.netlify.app/fonts/determinationsanswebregular-369x-webfont.woff") format("woff"),
         url("https://cheesy-website.netlify.app/fonts/determinationsanswebregular-369x.ttf") format("truetype");
  }

  body {
    margin: 0;
    padding: 0;
    background-color: black;
    color: white;
    font-family: "utfont";
    font-size: 28px;
    height: 100vh;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #start-button, #skip-button {
    font-family: "utfont";
    font-size: 32px;
    color: white;
    background: none;
    border: 2px solid white;
    padding: 10px 20px;
    cursor: pointer;
    position: absolute;
    z-index: 10;
  }

  #skip-button {
    top: 20px;
    right: 20px;
    display: none;
  }

  #trust-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: transparent;
    cursor: pointer;
    width: 40px;
    height: 40px;
    z-index: 20;
  }

  #start-button:hover, #skip-button:hover {
    color: yellow;
    border-color: yellow;
  }

  #startup-video, #bg-video {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
    display: none;
  }

  #nickname-screen, #chat-screen {
    width: 640px;
    max-width: 95%;
    display: none;
    flex-direction: column;
    align-items: center;
    opacity: 0;
    transition: opacity 1.5s ease;
  }

  #nickname-screen.show, #chat-screen.show {
    display: flex;
    opacity: 1;
  }

  #chat-box {
    border: 3px solid white;
    width: 100%;
    height: 400px;
    background-color: rgba(0,0,20,0.9);
    padding: 10px;
    overflow-y: auto;
    margin-bottom: 10px;
    white-space: pre-wrap;
  }

  .msg {
    margin: 6px 0;
  }

  .separator {
    text-align: center;
    opacity: 0.5;
    margin: 8px 0;
  }

  input, button {
    font-family: "utfont";
    font-size: 24px;
    color: white;
    background: black;
    border: 2px solid white;
    padding: 6px 10px;
    margin: 2px;
  }

  button:hover {
    color: yellow;
    border-color: yellow;
    cursor: pointer;
  }

  #chat-form {
    display: flex;
    width: 100%;
  }

  #chat-input {
    flex: 1;
  }
</style>
</head>
<body>

<button id="start-button">▶ START CHAT</button>
<button id="skip-button">SKIP INTRO</button>

<button id="trust-btn" title=" "></button>

<video id="startup-video">
  <source src="startup.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<video id="bg-video" loop>
  <source src="background.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<div id="nickname-screen">
  <div>ENTER NICKNAME:</div>
  <input type="text" id="nickname-input" placeholder="YOUR NAME">
  <div>ROOM CODE (leave empty for public):</div>
  <input type="text" id="room-input" placeholder="ROOM CODE">
  <button id="join-btn">JOIN CHAT</button>
</div>

<div id="chat-screen">
  <button id="load-older-btn" style="
    width: 100%;
    background: none;
    border: 2px solid white;
    color: white;
    font-family: utfont;
    font-size: 20px;
    padding: 5px;
    cursor: pointer;
    display: none;
    margin-bottom: 5px;
  ">LOAD OLDER MESSAGES</button>
  
  <div id="chat-box"></div>
  <form id="chat-form">
    <input id="chat-input" placeholder="TYPE MESSAGE..." autocomplete="off">
    <button type="submit">SEND</button>
  </form>
  <button id="change-nickname-btn">CHANGE NICKNAME</button>
</div>


<audio id="type-sound" src="type.wav"></audio>
<audio id="click-sound" src="click.wav"></audio>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://jynzopjzhmpmkeooqyrt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnpvcGp6aG1wbWtlb29xeXJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTYzODEsImV4cCI6MjA3NzEzMjM4MX0.o7rmQM3uEpaU8vXihOjIZDt8Vg8A2TX23sd1K51I80s";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let nickname = "";
let room = "public";
let lastSender = null;
let loadedCount = 50;
let oldestLoadedId = null;

const MESSAGE_LIMIT = 500;

const nicknameScreen = document.getElementById("nickname-screen");
const chatScreen = document.getElementById("chat-screen");
const chatBox = document.getElementById("chat-box");
const nicknameInput = document.getElementById("nickname-input");
const roomInput = document.getElementById("room-input");
const joinBtn = document.getElementById("join-btn");
const chatInput = document.getElementById("chat-input");
const chatForm = document.getElementById("chat-form");
const changeNickBtn = document.getElementById("change-nickname-btn");
const trustBtn = document.getElementById("trust-btn");

const typeSound = document.getElementById("type-sound");
const clickSound = document.getElementById("click-sound");

const blacklist = [
  "fuck","fucker","fucking","shit","shitting","bitch","asshole","bastard","slut","whore",
  "nigger","faggot","cunt","dick","pussy","retard",
  "kike","chink","spic","tranny","cock","nigga"
];

const TESTER_CODE = "Q5U4EX7YY2E9N";

function normalizeText(text) {
  return text.toLowerCase().replace(/[^a-z]/g, '');
}

function containsBadWord(text) {
  const normalized = normalizeText(text);
  return blacklist.some(word => normalized.includes(word));
}

function censorText(text) {
  let result = text;
  blacklist.forEach(word => {
    const pattern = word.split("").join("[^a-zA-Z]*");
    const regex = new RegExp(pattern, "gi");
    result = result.replace(regex, "****");
  });
  return result;
}

function testSwearFilter(message) {
  if (message === TESTER_CODE) {
    alert("Testing swear filter with tester code. Triggering bad word detection...");
    return "****";
  }
  return message;
}

function truncateMessage(text) {
  if (text.length > MESSAGE_LIMIT) {
    alert(`Message is too long! Truncating to ${MESSAGE_LIMIT} characters.`);
    return text.slice(0, MESSAGE_LIMIT);
  }
  return text;
}

function hasTrustedCookie() {
  return document.cookie.split(';').some(c => c.trim().startsWith('TRUSTED='));
}

function hasSpecialChars(str) {
  return /[^a-zA-Z0-9 _-]/.test(str);
}

joinBtn.onclick = () => {
  playClick();
  
  let inputNick = nicknameInput.value.trim() || "Anon" + Math.floor(Math.random() * 1000);

  if (inputNick.length > 390) inputNick = inputNick.slice(0, 390);

  if (containsBadWord(inputNick)) {
    alert("Your nickname contains inappropriate language. Please choose another one.");
    return;
  }

  if (hasSpecialChars(inputNick) && !hasTrustedCookie()) {
    alert("Nicknames cannot contain special characters unless you are a TRUSTED user.");
    return;
  }

  nickname = inputNick;
  room = roomInput.value.trim() || "public";
  nicknameScreen.classList.remove("show");
  nicknameScreen.style.display = "none";
  chatScreen.classList.add("show");
  subscribeToRoom(room);
};

changeNickBtn.onclick = () => {
  const newNick = prompt("Enter new nickname:", nickname);
  if (!newNick) return;

  if (newNick.length > 390) {
    alert("Nickname cannot be longer than 390 characters.");
    return;
  }

  if (containsBadWord(newNick)) {
    alert("Nickname contains inappropriate language. Please choose another one.");
    return;
  }

  if (hasSpecialChars(newNick) && !hasTrustedCookie()) {
    alert("Nicknames cannot contain special characters unless you are a TRUSTED user.");
    return;
  }

  nickname = newNick;
};

function playClick() { clickSound.currentTime = 0; clickSound.play(); }
function playType() { typeSound.currentTime = 0; typeSound.play(); }

chatForm.onsubmit = async (e) => {
  e.preventDefault();
  let text = chatInput.value.trim();
  if (!text) return;
  text = testSwearFilter(text);
  text = censorText(text);
  text = truncateMessage(text);
  await sb.from("messages").insert([{ sender: nickname, content: text, room: room }]);
  chatInput.value = "";
  playClick();
};

function parseBBColor(text) {
  return text.replace(/\[color=(#[0-9A-Fa-f]{6})\](.*?)\[\/color\]/g, '<span style="color:$1">$2</span>');
}

async function typeWriter(element, text, totalDuration = 2500, allowHTML = false) {
  element.innerHTML = "";
  const len = text.length;
  if (len === 0) return;
  const speed = Math.max(totalDuration / len, 10);

  for (let i = 0; i < len; i++) {
    if (allowHTML) element.innerHTML = text.slice(0, i + 1);
    else element.textContent = text.slice(0, i + 1);
    const isAtBottom = (chatBox.scrollTop + chatBox.clientHeight) >= (chatBox.scrollHeight - 10);
    if (isAtBottom) chatBox.scrollTop = chatBox.scrollHeight;
    playType();
    await new Promise(res => setTimeout(res, speed));
  }

  chatBox.scrollTop = chatBox.scrollHeight;
}

async function renderMessage(msg, useTypewriter = true, prepend = false) {
  if (lastSender !== null && lastSender !== msg.sender) {
    const line = document.createElement("div");
    line.className = "separator";
    line.textContent = "────────────────────────────";
    if (prepend) chatBox.insertBefore(line, chatBox.firstChild);
    else chatBox.appendChild(line);
  }

  const div = document.createElement("div");
  div.className = "msg";

  const senderParsed = parseBBColor(msg.sender);
  const contentParsed = parseBBColor(msg.content);

  if (useTypewriter) {
    await typeWriter(div, `${senderParsed}: ${contentParsed}`, 2500, true);
  } else {
    div.innerHTML = `${senderParsed}: ${contentParsed}`;
  }

  if (prepend) chatBox.insertBefore(div, chatBox.firstChild);
  else chatBox.appendChild(div);

  if (!prepend) chatBox.scrollTop = chatBox.scrollHeight;

  lastSender = msg.sender;
}


async function subscribeToRoom(roomName) {

  let { data: messages } = await sb
    .from("messages")
    .select("*")
    .eq("room", roomName)
    .order("id", { ascending: false })
    .limit(50);

  messages.reverse();

  chatBox.innerHTML = "";
  lastSender = null;

  if (messages.length > 0) {
    oldestLoadedId = messages[0].id;
    document.getElementById("load-older-btn").style.display = "block";
  }

  for (const msg of messages) {
    await renderMessage(msg, false);
  }

  sb.channel("room-" + roomName)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "messages",
      filter: `room=eq.${roomName}`
    }, payload => renderMessage(payload.new, true))
    .subscribe();
}


const startButton = document.getElementById("start-button");
const skipButton = document.getElementById("skip-button");
const startup = document.getElementById("startup-video");
const bg = document.getElementById("bg-video");

function startChatInterface() {
  startup.pause();
  startup.style.display = "none";
  skipButton.style.display = "none";
  bg.style.display = "block";
  bg.play();
  nicknameScreen.style.display = "flex";
  setTimeout(() => nicknameScreen.classList.add("show"), 100);
}

startButton.addEventListener("click", () => {
  playClick();
  startButton.style.display = "none";
  startup.style.display = "block";
  startup.play();
  skipButton.style.display = "block";
  startup.addEventListener("ended", startChatInterface);
});

skipButton.addEventListener("click", () => {
  playClick();
  startChatInterface();
});

async function loadOlderMessages() {
  if (!oldestLoadedId) return;

  const { data: older } = await sb
    .from("messages")
    .select("*")
    .eq("room", room)
    .lt("id", oldestLoadedId)
    .order("id", { ascending: false })
    .limit(50);

  if (!older || older.length === 0) {
    document.getElementById("load-older-btn").style.display = "none";
    return;
  }

  older.reverse();

  // Use renderMessage to render older messages with prepend flag
  for (const msg of older) {
    await renderMessage(msg, false, true); // prepend = true
  }

  oldestLoadedId = older[0].id;
}


document.getElementById("load-older-btn").onclick = async () => {
  playClick();
  await loadOlderMessages();
};

  
trustBtn.addEventListener("click", () => {
  const startVisible = !(startButton.style.display === "none");
  const startupPlaying = (startup.style.display === "block");
  const bgShowing = (bg.style.display === "block");
  if (!startVisible || startupPlaying || bgShowing) {
    return;
  }

  const obf = [27, 24, 24, 31, 27, 19, 19, 29];
  const key = 42;
  const decoded = obf.map(n => String.fromCharCode(n ^ key)).join('');

  const password = prompt("Enter password:");
  if (password === null) return;

  if (password === decoded) {
    document.cookie = "TRUSTED=true; path=/; expires=Fri, 31 Dec 9999 23:59:59 GMT";
    alert("Access granted. You are now a TRUSTED user.");
  } else {
    alert("Access denied.");
  }
});
</script>
</body>
</html>
