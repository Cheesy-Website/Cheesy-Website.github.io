<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CHATTING_PROGRAM.EXE</title>
<style>
  @font-face {
    font-family: "utfont";
    src: url("https://cheesy-website.netlify.app/fonts/determinationsanswebregular-369x-webfont.woff") format("woff"),
         url("https://cheesy-website.netlify.app/fonts/determinationsanswebregular-369x.ttf") format("truetype");
  }

  body {
    margin: 0;
    padding: 0;
    background-color: black;
    color: white;
    font-family: "utfont";
    font-size: 28px;
    height: 100vh;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #start-button, #skip-button {
    font-family: "utfont";
    font-size: 32px;
    color: white;
    background: none;
    border: 2px solid white;
    padding: 10px 20px;
    cursor: pointer;
    position: absolute;
    z-index: 10;
  }

  #skip-button {
    top: 20px;
    right: 20px;
    display: none;
  }

  #start-button:hover, #skip-button:hover {
    color: yellow;
    border-color: yellow;
  }

  #startup-video, #bg-video {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
    display: none;
  }

  #nickname-screen, #chat-screen {
    width: 640px;
    max-width: 95%;
    display: none;
    flex-direction: column;
    align-items: center;
    opacity: 0;
    transition: opacity 1.5s ease;
  }

  #nickname-screen.show, #chat-screen.show {
    display: flex;
    opacity: 1;
  }

  #chat-box {
    border: 3px solid white;
    width: 100%;
    height: 400px;
    background-color: rgba(0,0,20,0.9);
    padding: 10px;
    overflow-y: auto;
    margin-bottom: 10px;
    white-space: pre-wrap;
  }

  .msg {
    margin: 6px 0;
  }

  .separator {
    text-align: center;
    opacity: 0.5;
    margin: 8px 0;
  }

  input, button {
    font-family: "utfont";
    font-size: 24px;
    color: white;
    background: black;
    border: 2px solid white;
    padding: 6px 10px;
    margin: 2px;
  }

  button:hover {
    color: yellow;
    border-color: yellow;
    cursor: pointer;
  }

  #chat-form {
    display: flex;
    width: 100%;
  }

  #chat-input {
    flex: 1;
  }
</style>
</head>
<body>

<!-- Start and Skip Buttons -->
<button id="start-button">â–¶ START CHAT</button>
<button id="skip-button">SKIP INTRO</button>

<!-- Startup and Background Videos -->
<video id="startup-video">
  <source src="startup.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<video id="bg-video" loop>
  <source src="background.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

<!-- Chat UI -->
<div id="nickname-screen">
  <div>ENTER NICKNAME:</div>
  <input type="text" id="nickname-input" placeholder="YOUR NAME">
  <div>ROOM CODE (leave empty for public):</div>
  <input type="text" id="room-input" placeholder="ROOM CODE">
  <button id="join-btn">JOIN CHAT</button>
</div>

<div id="chat-screen">
  <div id="chat-box"></div>
  <form id="chat-form">
    <input id="chat-input" placeholder="TYPE MESSAGE..." autocomplete="off">
    <button type="submit">SEND</button>
  </form>
  <button id="change-nickname-btn">CHANGE NICKNAME</button>
</div>

<audio id="type-sound" src="type.wav"></audio>
<audio id="click-sound" src="click.wav"></audio>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://jynzopjzhmpmkeooqyrt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bnpvcGp6aG1wbWtlb29xeXJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTYzODEsImV4cCI6MjA3NzEzMjM4MX0.o7rmQM3uEpaU8vXihOjIZDt8Vg8A2TX23sd1K51I80s";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let nickname = "";
let room = "public";
let lastSender = null;

// Configuration for limiting message length
const MESSAGE_LIMIT = 500;  // Limit for individual messages

const nicknameScreen = document.getElementById("nickname-screen");
const chatScreen = document.getElementById("chat-screen");
const chatBox = document.getElementById("chat-box");
const nicknameInput = document.getElementById("nickname-input");
const roomInput = document.getElementById("room-input");
const joinBtn = document.getElementById("join-btn");
const chatInput = document.getElementById("chat-input");
const chatForm = document.getElementById("chat-form");
const changeNickBtn = document.getElementById("change-nickname-btn");

const typeSound = document.getElementById("type-sound");
const clickSound = document.getElementById("click-sound");

// ðŸ”’ Enhanced Bad-word filter
const blacklist = [
  "fuck","fucker","fucking","shit","shitting","bitch","asshole","bastard","slut","whore",
  "nigger","faggot","cunt","dick","pussy","retard",
  "kike","chink","spic","tranny","cock","nigga"
];

// Tester code
const TESTER_CODE = "Q5U4EX7YY2E9N";

// Normalize text: lowercase, remove non-alphabetic characters for checking
function normalizeText(text) {
  return text.toLowerCase().replace(/[^a-z]/g, '');
}

// Check if text contains any bad word (even if obfuscated)
function containsBadWord(text) {
  const normalized = normalizeText(text);
  return blacklist.some(word => normalized.includes(word));
}

// Censor message text for chat
function censorText(text) {
  let result = text;
  blacklist.forEach(word => {
    // Match word even if characters are separated by non-alphabetic characters
    const pattern = word.split("").join("[^a-zA-Z]*");
    const regex = new RegExp(pattern, "gi");
    result = result.replace(regex, "****");
  });
  return result;
}

// Test input for the tester code
function testSwearFilter(message) {
  if (message === TESTER_CODE) {
    alert("Testing swear filter with tester code. Triggering bad word detection...");
    return "****"; // Simulate a bad word being filtered
  }
  return message;
}

// Truncate message if it's too long (chat message limit)
function truncateMessage(text) {
  if (text.length > MESSAGE_LIMIT) {
    alert(`Message is too long! Truncating to ${MESSAGE_LIMIT} characters.`);
    return text.slice(0, MESSAGE_LIMIT);
  }
  return text;
}

joinBtn.onclick = () => {
  playClick();
  
  let inputNick = nicknameInput.value.trim() || "Anon" + Math.floor(Math.random() * 1000);

  // Trim to 390 chars max
  if (inputNick.length > 390) inputNick = inputNick.slice(0, 390);

  // Check for bad words in nickname
  if (containsBadWord(inputNick)) {
    alert("Your nickname contains inappropriate language. Please choose another one.");
    return;
  }

  nickname = inputNick;
  room = roomInput.value.trim() || "public";
  nicknameScreen.classList.remove("show");
  nicknameScreen.style.display = "none";
  chatScreen.classList.add("show");
  subscribeToRoom(room);
};

changeNickBtn.onclick = () => {
  const newNick = prompt("Enter new nickname:", nickname);
  if (!newNick) return;

  if (newNick.length > 390) {
    alert("Nickname cannot be longer than 390 characters.");
    return;
  }

  if (containsBadWord(newNick)) {
    alert("Nickname contains inappropriate language. Please choose another one.");
    return;
  }

  nickname = newNick;
};

function playClick() { clickSound.currentTime = 0; clickSound.play(); }
function playType() { typeSound.currentTime = 0; typeSound.play(); }

chatForm.onsubmit = async (e) => {
  e.preventDefault();
  let text = chatInput.value.trim();
  if (!text) return;
  text = testSwearFilter(text);  // Apply the tester code check
  text = censorText(text);      // Apply bad word filter
  text = truncateMessage(text); // Enforce message length limit
  await sb.from("messages").insert([{ sender: nickname, content: text, room: room }]);
  chatInput.value = "";
  playClick();
};

// Parse BBCode [color=#HEX]...[/color] to HTML
function parseBBColor(text) {
  return text.replace(/\[color=(#[0-9A-Fa-f]{6})\](.*?)\[\/color\]/g, '<span style="color:$1">$2</span>');
}

async function typeWriter(element, text, totalDuration = 2500, allowHTML = false) {
  element.innerHTML = "";
  const len = text.length;
  if (len === 0) return;
  const speed = Math.max(totalDuration / len, 10); // minimum delay

  for (let i = 0; i < len; i++) {
    if (allowHTML) {
      element.innerHTML = text.slice(0, i + 1);
    } else {
      element.textContent = text.slice(0, i + 1);
    }

    // Scroll dynamically: if user is near the bottom, keep it pinned
    const isAtBottom = (chatBox.scrollTop + chatBox.clientHeight) >= (chatBox.scrollHeight - 10);
    if (isAtBottom) chatBox.scrollTop = chatBox.scrollHeight;

    playType();
    await new Promise(res => setTimeout(res, speed));
  }

  // Make sure we finish scrolled to bottom
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ðŸ§± Render message
async function renderMessage(msg, useTypewriter = true) {
  if (lastSender !== null && lastSender !== msg.sender) {
    const line = document.createElement("div");
    line.className = "separator";
    line.textContent = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€";
    chatBox.appendChild(line);
  }

  const div = document.createElement("div");
  div.className = "msg";
  chatBox.appendChild(div);

  const senderParsed = parseBBColor(msg.sender);
  const contentParsed = parseBBColor(msg.content);

  if (useTypewriter) {
    await typeWriter(div, `${senderParsed}: ${contentParsed}`, 2500, true);
  } else {
    div.innerHTML = `${senderParsed}: ${contentParsed}`;
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  lastSender = msg.sender;
}

// ðŸ’¬ Subscribe to room and handle messages
async function subscribeToRoom(roomName) {
  const { data: messages } = await sb
    .from("messages")
    .select("*")
    .eq("room", roomName)
    .order("id", { ascending: true });

  chatBox.innerHTML = "";
  lastSender = null;

  // Old messages instantly
  for (const msg of messages) {
    await renderMessage(msg, false);
  }

  // New messages typewriter
  sb.channel("room-" + roomName)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "messages",
      filter: `room=eq.${roomName}`
    }, payload => renderMessage(payload.new, true))
    .subscribe();
}

// --- Startup sequence ---
const startButton = document.getElementById("start-button");
const skipButton = document.getElementById("skip-button");
const startup = document.getElementById("startup-video");
const bg = document.getElementById("bg-video");

function startChatInterface() {
  startup.pause();
  startup.style.display = "none";
  skipButton.style.display = "none";
  bg.style.display = "block";
  bg.play();
  nicknameScreen.style.display = "flex";
  setTimeout(() => nicknameScreen.classList.add("show"), 100);
}

startButton.addEventListener("click", () => {
  playClick();
  startButton.style.display = "none";
  startup.style.display = "block";
  startup.play();
  skipButton.style.display = "block";
  startup.addEventListener("ended", startChatInterface);
});

skipButton.addEventListener("click", () => {
  playClick();
  startChatInterface();
});
</script>
</body>
</html>
